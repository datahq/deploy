proxy:
  restart: always
  image: 'dockercloud/haproxy:latest'
  links:
    - frontend
    - assembler
    - auth
    - rawstore
    - specstore
  ports:
    - '80:80'
  roles:
    - global
frontend:
  autoredeploy: true
  restart: always
  image: datopian/datahub-frontend:latest
  ports:
    - "4000"
  environment:
    VIRTUAL_HOST: ${DOMAIN},https://${DOMAIN}
    DATAHUB_API: https://${DOMAIN_API}
auth:
  autoredeploy: true
  restart: always
  image: datopian/auth
  links:
    - postgres
  ports:
    - "8000"
  target_num_containers: 1
  environment:
    VIRTUAL_HOST: ${DOMAIN_API}/auth/*
    GUNICORN_PORT: 8000
    DATABASE_URL: "postgresql://datahub@postgres/datahub"
    EXTERNAL_ADDRESS: ${DOMAIN_API}
    PRIVATE_KEY:
    PUBLIC_KEY:
    GOOGLE_KEY:
    GOOGLE_SECRET:
    GITHUB_KEY:
    GITHUB_SECRET:
postgres:
  autoredeploy: true
  restart: always
  image: postgres
  target_num_containers: 1
  ports:
    - "5432"
  environment:
    POSTGRES_USER: "datahub"
    POSTGRES_DB: "datahub"
rawstore:
  autoredeploy: true
  restart: always
  image: 'datopian/bitstore:latest'
  ports:
    - '8000'
  target_num_containers: 1
  links:
    - auth
  environment:
    VIRTUAL_HOST: ${DOMAIN_API}/rawstore/*
    AUTH_SERVER: http://auth:8000
    STORAGE_ACCESS_KEY_ID: ${AWS_ACCESS_KEY}
    STORAGE_SECRET_ACCESS_KEY: ${AWS_SECRET_KEY}
    STORAGE_BUCKET_NAME: ${RAWSTORE_BUCKET}
    STORAGE_PATH_PATTERN: '{md5}'
assembler:
  autoredeploy: true
  restart: always
  environment:
    VIRTUAL_HOST: ${DOMAIN_API}/pipelines/*
    SOURCESPEC_REGISTRY_DB_ENGINE: postgresql://datahub@postgres/datahub
    DPP_BASE_PATH: /pipelines/
    PKGSTORE_BUCKET: ${PKGSTORE_BUCKET}
    AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY}
    AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_KEY}
  image: 'datopian/assembler:latest'
specstore:
  autoredeploy: true
  restart: always
  links:
    - auth
  environment:
    VIRTUAL_HOST: ${DOMAIN_API}/source/*
    AUTH_SERVER: auth:8000
    DATABASE_URL: postgresql://datahub@postgres/datahub
  expose:
    - '8000'
  image: 'datopian/specstore:latest'
elasticsearch:
  autoredeploy: true
  image: 'elasticsearch:latest'
  restart: always
metastore:
  autoredeploy: true
  restart: always
  links:
    - elasticsearch
  environment:
    VIRTUAL_HOST: ${DOMAIN_API}/metastore/*
    DATAHUB_ELASTICSEARCH_ADDRESS: elasticsearch:9200
    PRIVATE_KEY:
  expose:
    - '8000'
  image: 'datopian/metastore:latest'
